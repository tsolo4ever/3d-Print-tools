# UI Field Mapping System - Complete Guide

## Overview

The UI Field Mapping System connects Configuration.h `#define` statements to UI input fields in the Enhanced Printer Profiles interface. This enables automatic population of form fields when users import their firmware configuration files.

## System Architecture

```
Configuration.h ‚Üí Parser ‚Üí Staging Data ‚Üí UI Fields
     (#defines)    (metadata)  (uiFieldId)   (tab{N}_fieldName)
```

### Components

1. **Parser** (`marlin-config-parser.js`)
   - Reads Configuration.h files
   - Extracts `#define` values
   - Outputs metadata with `uiFieldId` for each field

2. **Core Mappings** (`assets/data/maps/th3d/TH3D UFW 2.97a/core/*.json`)
   - JSON files defining field mappings
   - Links `#define` names to UI field IDs
   - Generated by `create-comprehensive-mappings.py`
   - Enhanced with `add-ui-mappings.py`

3. **Tab Modules** (`assets/js/enhanced-profiles/tabs/tab-{N}-*.js`)
   - Render HTML with standardized field IDs
   - Format: `tab{N}_fieldName` (e.g., `tab1_profileName`)
   - Attach event listeners to update profile data

4. **Staging Data Manager** (`assets/js/staging-data-manager.js`)
   - Temporary storage for parsed config data
   - Includes `uiFieldId` for each field
   - Enables tab filtering and auto-population

## Field ID Naming Convention

### Standard Format
```
tab{N}_{fieldName}
```

Where:
- `{N}` = Tab number (1-10)
- `{fieldName}` = Descriptive camelCase name

### Examples
```javascript
// Tab 1: Printer Info
tab1_profileName        ‚Üí CUSTOM_MACHINE_NAME
tab1_firmwareVersion    ‚Üí UNIFIED_VERSION / SHORT_BUILD_VERSION

// Tab 2: Hardware
tab2_motherboard        ‚Üí MOTHERBOARD
tab2_extruders          ‚Üí EXTRUDERS
tab2_hotendTempSensor   ‚Üí TEMP_SENSOR_0
tab2_bedTempSensor      ‚Üí TEMP_SENSOR_BED
tab2_xDriverType        ‚Üí X_DRIVER_TYPE
tab2_yDriverType        ‚Üí Y_DRIVER_TYPE
tab2_zDriverType        ‚Üí Z_DRIVER_TYPE
tab2_e0DriverType       ‚Üí E0_DRIVER_TYPE
```

## Tab 1 & Tab 2 Implementation ‚úÖ

### Status: Complete & Validated

Both tabs have been fully implemented and validated:

```
üìã Tab 1: 2/2 fields valid (100%) ‚úÖ
  ‚úÖ tab1_profileName ‚Üí CUSTOM_MACHINE_NAME
  ‚úÖ tab1_firmwareVersion ‚Üí UNIFIED_VERSION

üìã Tab 2: 10/10 fields valid (100%) ‚úÖ
  ‚úÖ tab2_motherboard ‚Üí MOTHERBOARD
  ‚úÖ tab2_extruders ‚Üí EXTRUDERS
  ‚úÖ tab2_hotendTempSensor ‚Üí TEMP_SENSOR_0
  ‚úÖ tab2_hotend2TempSensor ‚Üí TEMP_SENSOR_1
  ‚úÖ tab2_bedTempSensor ‚Üí TEMP_SENSOR_BED
  ‚úÖ tab2_chamberTempSensor ‚Üí TEMP_SENSOR_CHAMBER
  ‚úÖ tab2_xDriverType ‚Üí X_DRIVER_TYPE
  ‚úÖ tab2_yDriverType ‚Üí Y_DRIVER_TYPE
  ‚úÖ tab2_zDriverType ‚Üí Z_DRIVER_TYPE
  ‚úÖ tab2_e0DriverType ‚Üí E0_DRIVER_TYPE
```

### Implementation Pattern

#### 1. HTML Field IDs
```javascript
render(profile, databases) {
  return `
    <!-- Use tab{N}_ prefix for all input fields -->
    <input type="text" id="tab1_profileName" value="${profile.name || ''}">
    <input type="text" id="tab1_firmwareVersion" value="${profile.firmwareVersion || ''}">
    
    <select id="tab2_motherboard">...</select>
    <input type="number" id="tab2_extruders" value="${hardware.extruders || 1}">
    <input type="number" id="tab2_hotendTempSensor" value="${hardware.thermistors?.hotend || 1}">
  `;
}
```

#### 2. Event Listeners
```javascript
attachListeners(profile, updateCallback, databases, context) {
  // Use getElementById with tab prefix
  const profileName = document.getElementById('tab1_profileName');
  if (profileName) {
    profileName.addEventListener('input', (e) => {
      profile.name = e.target.value;
      profile.modified = new Date().toISOString();
      updateCallback();
    });
  }
  
  const motherboard = document.getElementById('tab2_motherboard');
  if (motherboard) {
    motherboard.addEventListener('change', (e) => {
      profile.hardware.board = e.target.value;
      profile.modified = new Date().toISOString();
      updateCallback();
    });
  }
}
```

#### 3. Core Mapping Entries
```json
{
  "basic": {
    "serialPort": {
      "mapsFrom": ["SERIAL_PORT"],
      "type": "integer",
      "uiFieldId": "tab7_serialPort"
    }
  },
  "hardware": {
    "motherboard": {
      "mapsFrom": ["MOTHERBOARD"],
      "type": "define",
      "uiFieldId": "tab2_motherboard"
    },
    "tempSensor0": {
      "mapsFrom": ["TEMP_SENSOR_0"],
      "type": "integer",
      "uiFieldId": "tab2_hotendTempSensor"
    }
  }
}
```

## Validation System

### Running Validation
```bash
python firmware-helper/validate-ui-mappings.py
```

### What It Checks
1. **Field Existence**: All `uiFieldId` values have corresponding HTML inputs
2. **Tab Consistency**: Fields are in the correct tab files
3. **Unmapped Inputs**: Identifies inputs without mapping definitions
4. **Coverage**: Reports validation percentage per tab

### Validation Output
```
üìã Tab 1: 2 mapped fields
----------------------------------------------------------------------
  ‚úÖ tab1_firmwareVersion ‚Üí UNIFIED_VERSION
  ‚úÖ tab1_profileName ‚Üí CUSTOM_MACHINE_NAME

  Summary: 2 valid, 0 missing

======================================================================
SUMMARY
======================================================================
Total mapped fields:     97
Total input fields:      19
‚úÖ Valid mappings:       12
‚ùå Errors (missing):     85
üí° Unmapped inputs:      7
```

## Workflow for Adding Mapped Fields

### 1. Identify Configuration.h Define
```c
// From Configuration.h
#define MOTHERBOARD BOARD_CREALITY_V422
#define TEMP_SENSOR_0 1
#define DEFAULT_Kp 28.72
```

### 2. Add Mapping Entry
```bash
# Update add-ui-mappings.py
UI_FIELD_MAPPINGS = {
    'MOTHERBOARD': 'tab2_motherboard',
    'TEMP_SENSOR_0': 'tab2_hotendTempSensor',
    'DEFAULT_Kp': 'tab3_hotendPidKp',
}
```

### 3. Regenerate Mappings
```bash
# Run automation workflow
python firmware-helper/process-all-mappings.py
```

### 4. Add HTML Field
```javascript
// In tab-{N}-*.js render() method
<input type="number" id="tab3_hotendPidKp" 
  value="${profile.temperature?.pidKp || 28.72}" 
  step="0.01" 
  placeholder="28.72">
```

### 5. Add Event Listener
```javascript
// In attachListeners() method
const pidKp = document.getElementById('tab3_hotendPidKp');
if (pidKp) {
  pidKp.addEventListener('input', (e) => {
    if (!profile.temperature) profile.temperature = {};
    profile.temperature.pidKp = parseFloat(e.target.value) || 0;
    profile.modified = new Date().toISOString();
    updateCallback();
  });
}
```

### 6. Validate
```bash
python firmware-helper/validate-ui-mappings.py
```

## Data Flow Example

### 1. User Uploads Configuration.h
```c
#define MOTHERBOARD BOARD_CREALITY_V422
#define TEMP_SENSOR_0 1
```

### 2. Parser Extracts with Metadata
```javascript
{
  hardware: {
    motherboard: "BOARD_CREALITY_V422",
    tempSensor0: 1
  },
  _metadata: {
    "hardware.motherboard": {
      defineName: "MOTHERBOARD",
      uiFieldId: "tab2_motherboard",
      type: "define",
      profilePath: "hardware.motherboard"
    },
    "hardware.tempSensor0": {
      defineName: "TEMP_SENSOR_0",
      uiFieldId: "tab2_hotendTempSensor",
      type: "integer",
      profilePath: "hardware.tempSensor0"
    }
  }
}
```

### 3. Staging Data Created
```javascript
{
  parsedData: {
    "MOTHERBOARD": {
      value: "BOARD_CREALITY_V422",
      profilePath: "hardware.motherboard",
      uiFieldId: "tab2_motherboard",  // ‚Üê Used for auto-population
      type: "define",
      category: "hardware"
    },
    "TEMP_SENSOR_0": {
      value: 1,
      profilePath: "hardware.tempSensor0",
      uiFieldId: "tab2_hotendTempSensor",  // ‚Üê Used for auto-population
      type: "integer",
      category: "hardware"
    }
  }
}
```

### 4. UI Fields Auto-Populated (Future Phase)
```javascript
// Phase 2: Tab auto-population
const stagingData = StagingDataManager.loadStagingData();
for (const [defineName, field] of Object.entries(stagingData.parsedData)) {
  if (field.uiFieldId) {
    const input = document.getElementById(field.uiFieldId);
    if (input) {
      input.value = field.value;
      input.classList.add('from-staging');  // Visual indicator
    }
  }
}
```

## Current Status

### ‚úÖ Completed (Phase 1)
- [x] Parser enhanced with metadata output
- [x] Core mappings include `uiFieldId` properties
- [x] Tab 1 (Printer Info) - 100% validated
- [x] Tab 2 (Hardware) - 100% validated
- [x] Staging data system includes `uiFieldId`
- [x] Validation script created
- [x] Documentation complete

### ‚è≥ Remaining (Phase 2)
- [ ] Tab 3 (Hotend) - 0/6 fields
- [ ] Tab 4 (Bed) - 0/13 fields
- [ ] Tab 5 (Probe) - 0/9 fields
- [ ] Tab 6 (Motion) - 0/21 fields
- [ ] Tab 7 (Advanced) - 0/12 fields
- [ ] Tab 8 (Safety) - 0/10 fields
- [ ] Tab 9 (Nozzles) - 0/1 fields
- [ ] Tab 10 (Preferences) - 0/13 fields

### üöÄ Future Phases
- **Phase 3**: Automatic UI field population from staging data
- **Phase 4**: Visual indicators for staged vs. profile values
- **Phase 5**: Selective import with checkboxes
- **Phase 6**: Import conflict resolution UI

## Tab Mapping Reference

| Tab | Name | Mapped Fields | Status | Progress |
|-----|------|---------------|--------|----------|
| 1 | Printer Info | 2 | ‚úÖ Complete | 2/2 (100%) |
| 2 | Hardware | 10 | ‚úÖ Complete | 10/10 (100%) |
| 3 | Hotend | 6 | ‚è≥ Pending | 0/6 (0%) |
| 4 | Bed | 13 | ‚è≥ Pending | 0/13 (0%) |
| 5 | Probe | 9 | ‚è≥ Pending | 0/9 (0%) |
| 6 | Motion | 21 | ‚è≥ Pending | 0/21 (0%) |
| 7 | Advanced | 12 | ‚è≥ Pending | 0/12 (0%) |
| 8 | Safety | 10 | ‚è≥ Pending | 0/10 (0%) |
| 9 | Nozzles | 1 | ‚è≥ Pending | 0/1 (0%) |
| 10 | Preferences | 13 | ‚è≥ Pending | 0/13 (0%) |
| **Total** | | **97** | | **12/97 (12%)** |

## Benefits

### For Users
- ‚úÖ **One-Click Import**: Upload Configuration.h and auto-fill all settings
- ‚úÖ **No Manual Entry**: Save time and reduce errors
- ‚úÖ **Visual Feedback**: See which fields came from import
- ‚úÖ **Safe Preview**: Temporary staging before saving

### For Developers
- ‚úÖ **Single Source of Truth**: Mappings defined once in JSON
- ‚úÖ **Type Safety**: Parser includes type information
- ‚úÖ **Easy Validation**: Automated checking of field linkages
- ‚úÖ **Maintainable**: Add fields by updating JSON + HTML only

### For Maintainability
- ‚úÖ **Version-Specific**: Different mappings for firmware versions
- ‚úÖ **Documented**: Complete field reference in mapping files
- ‚úÖ **Testable**: Validation script ensures correctness
- ‚úÖ **Scalable**: Easy to add new tabs and fields

## Troubleshooting

### Field Not Populating
1. Check mapping file has `uiFieldId` property
2. Verify HTML input has correct ID (`tab{N}_fieldName`)
3. Run validation script to identify issues
4. Check browser console for parser errors

### Validation Errors
```bash
# Re-run UI mapping script
python firmware-helper/add-ui-mappings.py --mapping-dir "assets/data/maps/th3d/TH3D UFW 2.97a/core"

# Re-validate
python firmware-helper/validate-ui-mappings.py
```

### Parser Not Finding Field
1. Check if field is in core mapping (not full mapping)
2. Verify `mapsFrom` matches exact `#define` name
3. Check conditional requirements are met
4. Review parser console output for skipped fields

## Related Documentation

- **Parser Implementation**: `assets/js/PARSER_METADATA_IMPLEMENTATION.md`
- **Staging System**: `assets/js/STAGING_DATA_IMPLEMENTATION.md`
- **Mapping Automation**: `firmware-helper/AUTOMATED_MAPPING_WORKFLOW.md`
- **Tab Development**: `assets/js/enhanced-profiles/REFACTOR_PLAN.md`

## Quick Commands

```bash
# Add UI mappings to core files
python firmware-helper/add-ui-mappings.py --mapping-dir "assets/data/maps/th3d/TH3D UFW 2.97a/core"

# Validate all field mappings
python firmware-helper/validate-ui-mappings.py

# Generate new mappings
python firmware-helper/process-all-mappings.py

# Test parser
# Open firmware-helper/test-parser.html in browser
```

---

**Last Updated**: 2026-01-01  
**Status**: Phase 1 Complete (Tabs 1-2)  
**Next**: Implement Tabs 3-10 with UI field IDs
