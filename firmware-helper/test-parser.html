<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH3D Parser Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4fc3f7;
        }
        .file-upload {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 8px;
        }
        .file-upload label {
            display: block;
            margin-bottom: 10px;
            color: #4fc3f7;
            font-weight: bold;
        }
        input[type="file"] {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #555;
            border-radius: 4px;
            width: 100%;
        }
        button {
            background: #4fc3f7;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #29b6f6;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        #console {
            background: #1e1e1e;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            margin: 20px 0;
        }
        #output {
            background: #252526;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #4fc3f7; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üîß TH3D Multi-File Configuration Parser Test</h1>
    
    <div class="file-upload">
        <h2>Upload TH3D Configuration Files</h2>
        <p>Upload all 4 TH3D configuration files to test the parser:</p>
        
        <label>Configuration.h</label>
        <input type="file" id="config" accept=".h">
        
        <label>Configuration_adv.h</label>
        <input type="file" id="configAdv" accept=".h">
        
        <label>Configuration_backend.h</label>
        <input type="file" id="configBackend" accept=".h">
        
        <label>Configuration_speed.h</label>
        <input type="file" id="configSpeed" accept=".h">
        
        <button id="parseBtn" onclick="parseFiles()">Parse Configuration Files</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <h3>Console Output:</h3>
    <div id="console"></div>
    
    <h3>Parsed Configuration (JSON):</h3>
    <div id="output">No files parsed yet...</div>

    <script src="../assets/js/marlin-config-parser.js"></script>
    <script>
        // Hijack console.log to display in page
        const originalLog = console.log;
        const originalError = console.error;
        const consoleDiv = document.getElementById('console');
        
        function addToConsole(message, type = 'info') {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = message;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('ERROR: ' + args.join(' '), 'error');
        };
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        async function parseFiles() {
            const parseBtn = document.getElementById('parseBtn');
            parseBtn.disabled = true;
            
            try {
                clearConsole();
                addToConsole('=== Starting TH3D Configuration Parser Test ===', 'success');
                
                // Read all files
                const files = {};
                
                const configFile = document.getElementById('config').files[0];
                if (configFile) {
                    files.config = await configFile.text();
                    addToConsole('‚úì Loaded Configuration.h (' + configFile.size + ' bytes)', 'success');
                }
                
                const configAdvFile = document.getElementById('configAdv').files[0];
                if (configAdvFile) {
                    files.configAdv = await configAdvFile.text();
                    addToConsole('‚úì Loaded Configuration_adv.h (' + configAdvFile.size + ' bytes)', 'success');
                }
                
                const configBackendFile = document.getElementById('configBackend').files[0];
                if (configBackendFile) {
                    files.configBackend = await configBackendFile.text();
                    addToConsole('‚úì Loaded Configuration_backend.h (' + configBackendFile.size + ' bytes)', 'success');
                }
                
                const configSpeedFile = document.getElementById('configSpeed').files[0];
                if (configSpeedFile) {
                    files.configSpeed = await configSpeedFile.text();
                    addToConsole('‚úì Loaded Configuration_speed.h (' + configSpeedFile.size + ' bytes)', 'success');
                }
                
                if (Object.keys(files).length === 0) {
                    addToConsole('‚ö†Ô∏è No files selected! Please upload at least one configuration file.', 'warning');
                    parseBtn.disabled = false;
                    return;
                }
                
                addToConsole('', 'info');
                addToConsole('üöÄ Creating TH3D parser instance...', 'info');
                
                // Create TH3D parser instance
                const parser = MarlinConfigParser.create('th3d');
                // Set basePath for running from firmware-helper/ subdirectory
                parser.basePath = '../';
                addToConsole('‚úì Parser created', 'success');
                
                // Parse each file and merge results
                let result = {
                    basic: {},
                    hardware: {},
                    temperature: {},
                    motion: {},
                    probe: {},
                    bedLeveling: {},
                    advanced: {},
                    safety: {},
                    warnings: []
                };
                
                for (const [key, content] of Object.entries(files)) {
                    addToConsole('üìÑ Parsing ' + key + '...', 'info');
                    const parsed = await parser.parseConfigFile(content);
                    
                    // Merge results
                    Object.keys(parsed).forEach(category => {
                        if (category === 'warnings') {
                            result.warnings = result.warnings.concat(parsed.warnings || []);
                        } else if (typeof parsed[category] === 'object' && !Array.isArray(parsed[category])) {
                            result[category] = { ...result[category], ...parsed[category] };
                        }
                    });
                    
                    addToConsole('‚úì Parsed ' + key, 'success');
                }
                
                addToConsole('', 'info');
                addToConsole('‚úÖ All files parsed and merged!', 'success');
                addToConsole('', 'info');
                
                // Display results
                document.getElementById('output').textContent = JSON.stringify(result, null, 2);
                
                // Summary
                const fieldCount = Object.keys(result).reduce((sum, cat) => {
                    if (cat === 'warnings') return sum;
                    return sum + Object.keys(result[cat] || {}).length;
                }, 0);
                
                addToConsole('üìä Summary:', 'success');
                addToConsole('   ‚Ä¢ Total Fields Parsed: ' + fieldCount, 'info');
                addToConsole('   ‚Ä¢ Categories: ' + Object.keys(result).filter(k => k !== 'warnings').length, 'info');
                addToConsole('   ‚Ä¢ Warnings: ' + result.warnings.length, 'warning');
                
                if (result.warnings.length > 0) {
                    addToConsole('', 'info');
                    addToConsole('‚ö†Ô∏è Validation Warnings:', 'warning');
                    result.warnings.forEach(w => {
                        addToConsole('   ‚Ä¢ [' + w.level.toUpperCase() + '] ' + w.message, w.level === 'error' ? 'error' : 'warning');
                    });
                }
                
            } catch (error) {
                addToConsole('‚ùå Parse Error: ' + error.message, 'error');
                console.error(error);
                document.getElementById('output').textContent = 'Error: ' + error.message + '\n\n' + error.stack;
            } finally {
                parseBtn.disabled = false;
            }
        }
        
        // Initial message
        addToConsole('TH3D Configuration Parser Test Page loaded', 'success');
        addToConsole('Upload configuration files and click "Parse Configuration Files" to begin', 'info');
    </script>
</body>
</html>
